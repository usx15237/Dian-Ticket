<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0" />
    <title>title</title>
    <link rel="stylesheet" type="text/css" href="../../css/api.css" />
    <link rel="stylesheet" type="text/css" href="../../css/Todo.css" />
    <style type="text/css">
    body {
      background-image:url(../../image/beijing.jpg);
    }
    .click{
      border-radius:5px;
      margin-left: 10px;
      height: 40px;
      color: #fef4e9;
border: solid 1px #da7c0c;
background: #f78d1d;
background: -webkit-gradient(linear, left top, left bottom, from(#faa51a), to(#f47a20));
background: -moz-linear-gradient(top,  #faa51a,  #f47a20);
filter:  progid:DXImageTransform.Microsoft.gradient(startColorstr='#faa51a', endColorstr='#f47a20');
    }
    .click:hover {
      background: #f47c20;
background: -webkit-gradient(linear, left top, left bottom, from(#f88e11), to(#f06015));
background: -moz-linear-gradient(top,  #f88e11,  #f06015);
filter:  progid:DXImageTransform.Microsoft.gradient(startColorstr='#f88e11', endColorstr='#f06015');
    }
    .yuanying{
      margin-left: 10px;
    }
    .resion{
      height: 100px;
    }
    </style>
</head>

<body>
    <script id="interationTemp" type="text/x-dot-template">
        {{~it.array:value:index}}
        <li>
            <p>{{= value.row }}排{{= value.label }}座</p>
            <div class="buttons">
                <button class="deleteButton" id="delete" onclick="del({{= index}})"><!--?xml version="1.0" encoding="utf-8"?--><svg version="1.1" id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewBox="0 0 22 22" style="enable-background:new 0 0 22 22;" xml:space="preserve"><g><g><path class="fill" d="M16.1,3.6h-1.9V3.3c0-1.3-1-2.3-2.3-2.3h-1.7C8.9,1,7.8,2,7.8,3.3v0.2H5.9c-1.3,0-2.3,1-2.3,2.3v1.3c0,0.5,0.4,0.9,0.9,1v10.5c0,1.3,1,2.3,2.3,2.3h8.5c1.3,0,2.3-1,2.3-2.3V8.2c0.5-0.1,0.9-0.5,0.9-1V5.9C18.4,4.6,17.4,3.6,16.1,3.6z M9.1,3.3c0-0.6,0.5-1.1,1.1-1.1h1.7c0.6,0,1.1,0.5,1.1,1.1v0.2H9.1V3.3z M16.3,18.7c0,0.6-0.5,1.1-1.1,1.1H6.7c-0.6,0-1.1-0.5-1.1-1.1V8.2h10.6L16.3,18.7L16.3,18.7z M17.2,7H4.8V5.9c0-0.6,0.5-1.1,1.1-1.1h10.2c0.6,0,1.1,0.5,1.1,1.1V7z"></path></g><g><g><path class="fill" d="M11,18c-0.4,0-0.6-0.3-0.6-0.6v-6.8c0-0.4,0.3-0.6,0.6-0.6s0.6,0.3,0.6,0.6v6.8C11.6,17.7,11.4,18,11,18z"></path></g><g><path class="fill" d="M8,18c-0.4,0-0.6-0.3-0.6-0.6v-6.8C7.4,10.2,7.7,10,8,10c0.4,0,0.6,0.3,0.6,0.6v6.8C8.7,17.7,8.4,18,8,18z"></path></g><g><path class="fill" d="M14,18c-0.4,0-0.6-0.3-0.6-0.6v-6.8c0-0.4,0.3-0.6,0.6-0.6c0.4,0,0.6,0.3,0.6,0.6v6.8C14.6,17.7,14.3,18,14,18z"></path></g></g></g></svg></button>
            </div>
            </button>
        </li>
        {{~}}
    </script>

    <div class="wrapper">
        <header>
            <input type="text" autofocus placeholder="请输入转让原因(买错/临时有事)" id="item">
            <div id='animationDiv'>
                <button id="add" onclick="add()">
    				<svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"viewBox="0 0 16 16" style="enable-background:new 0 0 16 16;" xml:space="preserve"><g><path class="fill" d="M16,8c0,0.5-0.5,1-1,1H9v6c0,0.5-0.5,1-1,1s-1-0.5-1-1V9H1C0.5,9,0,8.5,0,8s0.5-1,1-1h6V1c0-0.5,0.5-1,1-1s1,0.5,1,1v6h6C15.5,7,16,7.5,16,8z"/></g></svg>
    			</button>
            </div>
        </header>
        <div class="container">
            <ul class="todo" id="Todo">
            </ul>
            <hr class="divider">
        </div>
    </div>
    <div class="yuanying">转让原因：<br><span id="reason" class="resion"></span></div>
    <div class="col-md-3 col-sm-3 col-xs-6">
        <button href="#" id="submit" class="click" onclick="submit()">提交转让请求</button>
        <button href="#" id="submit" class="click" onclick="goBack()">取消转让</button>
    </div>
</body>
<script type="text/javascript" src="../../script/api.js"></script>
<script type="text/javascript" src="../../script/doT.min.js"></script>
<script type="text/javascript">
    apiready = function() {
        msginit();
        InitData();
        updateTransfer();
    };

    //获取影票信息，并设置中间变量ticketObj.transfernext_chairs用于存放下次供用户挑选的座位
    function InitData() {

        ticketObj = api.pageParam;
        ticketObj.transfernext_chairs = [];
    }

    //transfer_chairs负责存放供用户挑选的待转让座位，我们需要展示它
    function updateTransfer() {
        var interationData = {
            "array": ticketObj.transfer_chairs
        };
        var interation = doT.template($api.dom('#interationTemp').innerHTML);
        $api.dom('#Todo').innerHTML = interation(interationData);
    }

    //提示语
    function msginit() {
        alert('请说明转让原因，并选择转让座位')
    }

    function add() {
        $api.dom('#reason').innerHTML = $api.dom('#item').value
        $api.dom('#item').value = "";
    }

    function goBack() {
        api.closeWin({});

    };

    //提交转让座位
    function submit() {

        for (var i = 0; i < ticketObj.transfer_chairs.length; i++) {
            var index = turnTransfer(ticketObj.transfer_chairs[i]);
            ticketObj.chairs[index].statue = '待转让';
            ticketObj.transfering_chairs.push(ticketObj.transfer_chairs[i]);
        }

        ticketObj.transfer_chairs = ticketObj.transfernext_chairs;

        var model = api.require('model');
        model.updateById({
            class: 'Ticket',
            id: ticketObj.id,
            value: {
                chairs: ticketObj.chairs,
                //把下次供用户挑选的座位放入transfer_chairs
                transfer_chairs: ticketObj.transfernext_chairs,
                //transfering_chairs放置处于待转让状态的座位
                transfering_chairs: ticketObj.transfering_chairs
            }
        }, function(ret, err) {
            if (ret) {
                $api.setStorage('key', ticketObj);
               var query=api.require('query');
                query.createQuery(
                    function(ret, err) {
                        query.whereEqual({
                            qid: ret.qid,
                            column: 'TicketId',
                            value: ticketObj.id
                        });
                        //TicketStack为数据库中的转让影票列表，一条TicketStack数据对应一条Ticket数据
                        model.findAll({
                            class: 'TicketStack',
                            qid: ret.qid
                        }, function(ret, err) {
                            if (ret[0]){
                              api.sendEvent({
                                  name: 'setstatue'
                              });
                              $api.rmStorage('key');
                              $api.setStorage('key', ticketObj);
                              api.closeWin({});
                            }
                            else {
                                model.insert({
                                    class: 'TicketStack',
                                    value: {
                                        movie_name: ticketObj.ScheduleId.movie_name,
                                        TicketId: ticketObj.id,
                                        ScheduleId: ticketObj.ScheduleId.id,
                                        userId: ticketObj.userId,
                                        transferReason: $api.dom('#reason').innerHTML
                                    }
                                }, function(ret, err) {
                                  api.sendEvent({
                                      name: 'setstatue'
                                  });
                                  $api.rmStorage('key');
                                  $api.setStorage('key', ticketObj);
                                  api.closeWin({});
                                });

                            }

                        });
                    })
            }
        });
    }

    //找到所删除项在transfer_chairs中对应的index值
    function turnTransfer(chair_value) {
        for (var i = 0; i < ticketObj.chairs.length; i++) {
            if (chair_value.row == ticketObj.chairs[i].row && chair_value.label == ticketObj.chairs[i].label) {
                return i;
            }
        }
    }

    function del(index) {

        //获取不需要转让的座位
        var chair_value = {};
        chair_value.row = ticketObj.transfer_chairs[index].row;
        chair_value.label = ticketObj.transfer_chairs[index].label;

        //把它从这次供用户挑选的座位列表中删除
        ticketObj.transfer_chairs.splice(index, 1);

        //把它加入到下次供用户挑选的座位列表中去
        ticketObj.transfernext_chairs.push(chair_value);

        updateTransfer();
    }
</script>

</html>
